{
    "Python Driver Template": {
        "scope": "python",
        "prefix": "drivertemplate",
        "body": [
            "from datetime import datetime as dat",
            "from os.path import exists",
            "from os import path, remove, makedirs",
            "from xml.etree.ElementTree import Element as Re, SubElement as Se, tostring as Ts",
            "from xml.dom.minidom import parseString as pS",
            "import http.client as hC",
            "import ssl",
            "import json",
            "from json import loads, dumps",
            "import base64",
            "import uuid",
            "import IDesign as apex  # type:ignore",
            "",
            "sslCnxt = None",
            "",
            "lID2uID = {}",
            "uID2Obj = {}",
            "",
            "class Drv:",
            "    pDir = path.expanduser(\"~\") + \"/Documents/Integration Designer/DbgLogs\"",
            "    fPth = path.join(pDir, \"Driver.log\")  # rename the file name according to driver",
            "    if not exists(pDir):",
            "        makedirs(pDir)",
            "    if exists(fPth):",
            "        remove(fPth)",
            "    isInit = False",
            "    cnfXML = \"\"",
            "    varXML = \"\"",
            "    fncXML = \"\"",
            "    evtXML = \"\"",
            "    cxmlstr = \"\"",
            "    vxmlstr = \"\"",
            "    exmlstr = \"\"",
            "    fxmlstr = \"\"",
            "    d = None",
            "    drvNm = \"\"",
            "",
            "class Dev:",
            "    Nm = \"\"",
            "    dDat = {}",
            "    isDev = \"\"",
            "",
            "def gtDate(p):",
            "    nw = dat.now()",
            "    ms = str(round(int(nw.strftime(\"%f\")) / 1000))",
            "    if p:",
            "        return nw.strftime(\"%d.%b.%Y %H:%M:%S:\") + ms + \":: \"",
            "    else:",
            "        return nw.strftime(\"%d%b%Y-%H%M\")",
            "",
            "def dbg(msg):",
            "    if exists(Drv.fPth):",
            "        f = open(Drv.fPth, \"a\")",
            "    else:",
            "        f = open(Drv.fPth, \"w\")",
            "    msg = gtDate(True) + msg + \"\\n\"",
            "    f.write(msg)",
            "    f.close()",
            "",
            "def err(m):",
            "    if exists(Drv.fPth):",
            "        f = open(Drv.fPth, \"a\")",
            "    else:",
            "        f = open(Drv.fPth, \"w\")",
            "    msg = gtDate(True) + \"[ERR] \" + str(m) + \"\\n\"",
            "    f.write(msg)",
            "    f.close()",
            "",
            "def savFunc(db):  # Helper Func to Generate Functions XML",
            "    if not Drv.d:",
            "        err(\"savFunc: Drv.d is not initialized\")",
            "        return",
            "    Drv.d.set_functions(Drv.fxmlstr)",
            "    if db:",
            "        dbg(f\"Functions Data:\\t{Drv.fxmlstr}\")",
            "",
            "def savEvnt(db):  # Helper Func to Generate Events XML",
            "    if not Drv.d:",
            "        err(\"savEvnt: Drv.d is not initialized\")",
            "        return",
            "    Drv.d.set_events(Drv.exmlstr)",
            "    if db:",
            "        dbg(f\"Events Data:\\t{Drv.exmlstr}\")",
            "",
            "def savVar(db):  # Helper Func to Generate Variables XML",
            "    if not Drv.d:",
            "        err(\"savVar: Drv.d is not initialized\")",
            "        return",
            "    Drv.d.set_system_variables(Drv.vxmlstr)",
            "    if db:",
            "        dbg(f\"Variables Data:\\t{Drv.vxmlstr}\")",
            "",
            "def savCnf(db):",
            "    if not Drv.d:",
            "        err(\"savCnf: Drv.d is not initialized\")",
            "        return",
            "    Drv.d.set_config(Drv.cxmlstr)",
            "    Drv.d.config_changed(\"\")",
            "    Drv.d.save()",
            "    if db:",
            "        dbg(f\"Configuration Settings Data:\\t{Drv.cxmlstr}\")",
            "",
            "def toUID(rID):",
            "    global lID2uID",
            "    if not rID:",
            "        return \"00000000\"",
            "    rID = str(rID)",
            "    if rID in lID2uID:",
            "        return lID2uID[rID]",
            "    clnd = rID.replace(\"-\", \"\").lower()",
            "    hshvl = 0",
            "    for char in clnd:",
            "        hshvl = ((hshvl << 5) - hshvl) + ord(char)",
            "        hshvl = hshvl & 0xFFFFFFFF",
            "    if hshvl > 0x7FFFFFFF:",
            "        hshvl = hshvl - 0x100000000",
            "    hshvl = abs(hshvl)",
            "    uID = toBs36(hshvl)",
            "    while len(uID) < 8:",
            "        uID = \"0\" + uID",
            "    if len(uID) > 8:",
            "        uID = uID[:8]",
            "    lID2uID[rID] = uID",
            "    return uID",
            "",
            "def toBs36(num):",
            "    if num == 0:",
            "        return \"0\"",
            "    chars = \"0123456789abcdefghijklmnopqrstuvwxyz\"",
            "    res = \"\"",
            "    while num > 0:",
            "        res = chars[num % 36] + res",
            "        num = num // 36",
            "    return res",
            "",
            "def crtSSLCnxt():",
            "    global sslCnxt",
            "    sslCnxt = ssl.create_default_context()",
            "    sslCnxt.check_hostname = False",
            "    sslCnxt.verify_mode = ssl.CERT_NONE",
            "    dbg(\"SSL Context created (certificate verification disabled)\")",
            "    return sslCnxt",
            "",
            "def sndRqst(mtd, path_url, data=None, hdrs=None, timeout=10):",
            "    global sslCnxt",
            "    try:",
            "        dbg(f\"Sending Request: {mtd} {path_url}\")",
            "        #! url = driverCnf.get(\"domain\", \"api.example.com\") ------- based on the driver",
            "        if not sslCnxt:",
            "            crtSSLCnxt()",
            "        conn = hC.HTTPSConnection(",
            "            #! url, driverCnf[\"port\"], context=sslCnxt, timeout=timeout",
            "        )",
            "        body = None",
            "        hdrs = hdrs or {}",
            "        if data is not None:",
            "            body = json.dumps(data)",
            "            hdrs[\"Content-Type\"] = \"application/json\"",
            "",
            "        #! if \"x-api-key\" not in hdrs and driverCnf.get(\"x-api-key\"):",
            "        #!     hdrs[\"x-api-key\"] = driverCnf[\"x-api-key\"]",
            "",
            "        conn.request(mtd, path_url, body=body, headers=hdrs)",
            "        res = conn.getresponse()",
            "        txt = res.read().decode(\"utf-8\")",
            "        conn.close()",
            "        dbg(f\"Response: {res.status}\")",
            "",
            "        prsd = None",
            "        if txt:",
            "            try:",
            "                prsd = json.loads(txt)",
            "            except json.JSONDecodeError as e:",
            "                err(f\"JSON parse error: {e}\")",
            "                prsd = txt",
            "",
            "        if res.status >= 400:",
            "            err(f\"Request failed: {res.status} - {txt}\")",
            "",
            "        return res.status, prsd",
            "    except Exception as e:",
            "        err(f\"Request Sent error: {e}\")",
            "        return None, None",
            "",
            "def upd_data():",
            "    pass",
            "",
            "def crtCnfXml():",
            "    dbg(\"Creating Configuration XML...\")",
            "",
            "    # Initialize XML root",
            "    cnfg = Re(\"configuration\")",
            "",
            "    # Debug Settings",
            "    dbgCtgy = Se(",
            "        cnfg,",
            "        \"category\",",
            "        name=\"Debug Settings\",",
            "        description=\"Log and Debug Settings for the Driver.\",",
            "    )",
            "    Se(",
            "        dbgCtgy,",
            "        \"setting\",",
            "        name=\"Debug Info\",",
            "        type=\"boolean\",",
            "        variable=\"dInf\",",
            "        default=\"0\",",
            "    )",
            "    Se(",
            "        dbgCtgy,",
            "        \"setting\",",
            "        name=\"Debug Warning\",",
            "        type=\"boolean\",",
            "        variable=\"dWrn\",",
            "        default=\"0\",",
            "    )",
            "    Se(",
            "        dbgCtgy,",
            "        \"setting\",",
            "        name=\"Debug Error\",",
            "        type=\"boolean\",",
            "        variable=\"dErr\",",
            "        default=\"1\",",
            "    )",
            "",
            "    # Driver Settings",
            "    dvrCtgy = Se(",
            "        cnfg,",
            "        \"category\",",
            "        name=\"Driver Settings\",",
            "        description=\"Settings for driver integration.\",",
            "    )",
            "",
            "    # Driver Name",
            "    Se(",
            "        dvrCtgy,",
            "        \"setting\",",
            "        name=\"Driver Name\",",
            "        type=\"string\",",
            "        variable=\"drvNm\",",
            "        description=\"Enter Name to identify this Driver instance in Program.\",",
            "        default=\"Driver Name\",  # todo Modify Driver Name",
            "    )",
            "",
            "    Drv.cnfXML = cnfg",
            "    xmlBdy = Ts(cnfg, encoding=\"unicode\")",
            "    xml = '<?xml version=\"1.0\" encoding=\"utf-8\"?>' + xmlBdy",
            "    try:",
            "        Drv.cxmlstr = pS(xml).toprettyxml(indent=\"  \")",
            "    except Exception as e:",
            "        err(f\"crtCnfXml: Error writing XML file: {e}\")",
            "        Drv.cxmlstr = xml",
            "",
            "    savCnf(False)",
            "    #!dbg(f\"Generated configuration for {} devices\")",
            "    return Drv.cxmlstr",
            "",
            "def crtEvntXml():",
            "    pass",
            "",
            "def crtVarXml():",
            "    pass",
            "",
            "def crtFuncXml():",
            "    pass",
            "",
            "def genAllXML(setVals=True):",
            "    dbg(\"Generating XML configurations...\")",
            "    crtEvntXml()",
            "    crtFuncXml()",
            "    crtVarXml()",
            "    dbg(\"All XML configurations generated\")",
            "",
            "    if setVals:",
            "        savFunc(False)",
            "        savEvnt(False)",
            "        savVar(False)",
            "",
            "def init(d):",
            "    global sslCnxt, uID2Obj, lID2uID",
            "    Drv.d = d",
            "    Drv.isInit = True",
            "    dbg(\"Initializing Driver...\")",
            "",
            "    #!Add your load Configuration according to config settings",
            "",
            "    # Initialize SSL",
            "    if not sslCnxt:",
            "        crtSSLCnxt()",
            "    Dev.isDev = Drv.d.get_private_config_value(\"isData\")",
            "    try:",
            "        if Dev.isDev and int(Dev.isDev) >= 1:",
            "            uIDobj_str = Drv.d.get_private_config_value(\"uIDobj\")",
            "            lID2uID_str = Drv.d.get_private_config_value(\"lID2uID\")",
            "            if uIDobj_str:",
            "                uID2Obj=loads(uIDobj_str)",
            "                dbg(f\"Loaded {len(uID2Obj)} devices from private config\")",
            "            if lID2uID_str:",
            "                lID2uID=loads(lID2uID_str)",
            "    except Exception as e:",
            "        err(f\"init: Error loading saved data: {e}\")",
            "        Dev.isDev = \"0\"",
            "",
            "    crtCnfXml()",
            "    savCnf(False)",
            "    dbg(\"Driver initialization complete\")",
            "",
            "def mkDta(d):",
            "    dbg(\"Building Driver Data...\")",
            "    if not Drv.isInit:",
            "        init(d)",
            "    if not uID2Obj:",
            "        apex.messagebox(",
            "            \"No device data found. Please run 'Get Devices' first.\",",
            "            apex.MessageBoxStyles.MB_OK,",
            "        )",
            "        return",
            "    try:",
            "        genAllXML(True)",
            "",
            "        #! lDat = dumps(lID2uID)",
            "        #! dDat = dumps(uID2Obj)",
            "        #! apiKey = driverCnf.get(\"x-api-key\", \"\")",
            "        #! subscriberId = subId or \"\"",
            "        #! dataJs = f\"\"\"var uID2Obj = {dDat};",
            "        #!         var lID2uID = {lDat};",
            "        #!         var apiKey = \"{apiKey}\";",
            "        #!         var subscriberID = \"{subscriberId}\";\"\"\"",
            "        #! may vary this data.js according to what data you want to send to runtime",
            "        Drv.d.set_processor_script(dataJs, \"Data.js\")",
            "        Drv.d.set_private_config_value(\"uIDobj\", dDat)",
            "        Drv.d.set_private_config_value(\"lID2uID\", lDat)",
            "        Drv.d.set_private_config_value(\"isData\", \"1\")",
            "        savCnf(True)",
            "        dbg(\"Driver data built successfully\")",
            "        apex.messagebox(",
            "            \"Building Driver successfully. You may now configure the UI.\",",
            "            apex.MessageBoxStyles.MB_OK,",
            "        )",
            "    except Exception as e:",
            "        err(f\"mkDta: Error building driver data: {e}\")",
            "        apex.messagebox(f\"Error building driver data: {e}\", apex.MessageBoxStyles.MB_OK)",
            "",
            "def PrepDat():",
            "    dbg(\"Starting Device Import...\")",
            "    if not Drv.isInit:",
            "        init(d)",
            "",
            "    # Check if data exists",
            "    if Dev.isDev and int(Dev.isDev) >= 1:",
            "        res = apex.messagebox(",
            "            \"Device data already exists. Re-import?\",",
            "            apex.MessageBoxStyles.MB_YESNO,",
            "        )",
            "        if res == apex.MessageBoxReturnValues.IDNO:",
            "            return",
            "        Drv.d.set_private_config_value(\"isData\", \"0\")",
            "        Dev.isDev = \"0\"",
            "",
            "    apex.show_pleasewait_dialog(\"Fetching data\")",
            "    try:",
            "        pass",
            "        #! Add Logic Fetch device data, update driver state, and rebuild config",
            "",
            "        genAllXML(False)",
            "        crtCnfXml()",
            "        savCnf(False)",
            "",
            "        dbg(f\"Imported successfully\")",
            "        apex.messagebox(",
            "            f\"Driver Data Import Successful.\",",
            "            apex.MessageBoxStyles.MB_OK,",
            "        )",
            "    except Exception as e:",
            "        apex.clear_pleasewait_dialog()",
            "        err(f\"PrepDat: Error during import: {e}\")",
            "        apex.messagebox(",
            "            f\"An error occurred during import: {e}\", apex.MessageBoxStyles.MB_OK",
            "        )",
            "",
            "apex.register_menu_callback(\"Get Devices\", PrepDat)",
            "apex.register_menu_callback(\"Build Driver\", mkDta)",
            "apex.register_load_callback(init)",
            "apex.register_updated_callback(init)"
        ],
        "description": "Integration Designer Python Driver Template"
    },
    
    "Integration Designer COM Functions": {
        "scope": "commjs",
        "prefix": "defcom",
        "body": [
            "function defCom() {",
            "  comObj = new HTTP(comRx);",
            "  comObj.OnConnectFunc = dOn;",
            "  comObj.OnDisconnectFunc = dOff;",
            "  comObj.OnConnectFailedFunc = dCnFail;",
            "  comObj.OnSSLHandshakeOKFunc = onSSLHdShkOK;",
            "  comObj.OnSSLHandshakeFailedFunc = onSSLHdShkFailed;",
            "  httpCon = new ScheduledEvent(opnCom, \"Periodic\", \"Seconds\", 1);",
            "  httpCon.Enable();",
            "}",
            "",
            "function dOn() {",
            "  log.Inf(\"Connected\");",
            "  isCntd = true;",
            "  comObj.StartSSLHandshake();",
            "}",
            "",
            "function dCnFail() {",
            "  log.Err(\"Unable to connect. Reconnecting...\");",
            "  httpCon.Enable();",
            "}",
            "",
            "function dOff() {",
            "  (comObj.Disconnect(), System.Sleep(100), comObj.Close());",
            "  log.Inf(\"Disconnected\");",
            "  isCntd = false;",
            "}",
            "",
            "function onSSLHdShkOK() {",
            "  log.Inf(\"SSL Handshake OK.\");",
            "  updPoll();",
            "  defWs(); // To be Implemented Later.",
            "}",
            "",
            "function onSSLHdShkFailed() {",
            "  log.Err(\"SSL HandShake Failed\");",
            "  isCntd = false;",
            "  if (comObj && comObj.OpenState) {",
            "    comObj.Close();",
            "  }",
            "  httpCon.Enable();",
            "}",
            "",
            "function opnCom(r) {",
            "  r = r || false;",
            "  r || comObj",
            "    ? (comObj.Disconnect(),",
            "      System.Sleep(100),",
            "      comObj.Close(),",
            "      System.Sleep(100))",
            "    : \"\";",
            "  comObj.Open(\"api.aaecosystem.com\", 443);",
            "  httpCon.Disable();",
            "}",
            "",
            "function updPoll() {",
            "  var lIDs = Object.keys(lID2uID);",
            "  log.Inf(\"access_token: \" + access_token);",
            "  for (var i = 0; i < lIDs.length; i++) {",
            "    sndAPIRqst(\"GET\", \"/locks/\" + lIDs[i]);",
            "  }",
            "  if (rqstArr.length && !rqstTmr.State) {",
            "    rqstTmr.Start(sndRqst, 500);",
            "  }",
            "}"
        ],
        "description": "Integration Designer COM Communication Functions"
    }

}